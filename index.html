<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask âœ…LinkedIn QARA - Med MindsðŸ”Ž Applicable Standards Selector</title>
    <link rel="icon" href="QARA.png" type="image/png">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            align-items: center;
        }
        #topContainer {
            width: 100%;
            background-color: white;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 20px;
        }
        h1 {
            margin-bottom: 20px;
            background-color: white;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: fit-content;
        }
        #keywordInput {
            width: 50%;
            min-height: 120px;
            margin-bottom: 20px;
            padding: 8px;
            resize: none;
        }
        #buttonContainer {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        #tableContainer {
            width: 100%;
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #ccc;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            cursor: pointer;
        }
        th {
            background-color: #add8e6;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:nth-child(even) {
            background-color: #e6f2ff;
        }
        tr.selected-row {
            background-color: yellow;
        }
        tr.new-row {
            background-color: lightgreen;
        }
        button {
            padding: 10px;
        }
        #loadingIndicator {
            display: none;
            margin-left: 10px;
        }
        #progressMessage {
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-81366NTXDQ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-81366NTXDQ');
</script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
 <div id="topContainer">
 <header>
        <img src="https://content.linkedin.com/content/dam/me/business/en-us/amp/brand-site/v2/bg/LI-Logo.svg.original.svg" alt="LinkedIn Logo">
        <a href="https://www.linkedin.com/groups/12741229/">
        <img src="https://media.licdn.com/dms/image/v2/D4E07AQFTIdPpIdlhCQ/group-logo_image-shrink_92x92/group-logo_image-shrink_92x92/0/1670075584338?e=1727884800&v=beta&t=J8szLXmrM9RSWZ2YPdkVfvIgkTSfnP50baeyLTXO6OA" alt="QARA Logo"></a>     
 </header>    
<h1>Ask âœ…LinkedIn QARA - Med MindsðŸ”Ž Applicable Standards Selector</h1>
    <textarea id="keywordInput" placeholder="
        1. Search Context: Enter keywords, standards number, text from document... here.
        2. Click on Submit Context
        3. Select rows that you need with mouse click, they will toggle yellow 
        4. Repeat 1-3 as needed
        5. Export selected rows to a file"></textarea>
    <div id="buttonContainer">
        <button id="submitContext">Submit Context</button>
        <button id="clearContext">Clear Context</button>
        <button id="displaySelected">Display All Selected Rows</button>
        <button id="export">Export Selected Rows</button>
        <button id="reset">Reset</button>
        <span id="loadingIndicator">Loading...</span>
    </div>
    <div id="progressMessage"></div>
 </div>
    <div id="tableContainer">
        <table id="dataTable">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>
    <script>
        $(document).ready(function() {
            const csvUrl = 'https://martincking.github.io/Standards-Selector/Standards.csv';
            let allRows = []; 
            let originalRows = [];
            let selectedRows = new Set(); 
            let displayedRows = new Set(); 
            let newTopRows = new Set(); 

            $.get(csvUrl, function(data) {
                const lines = data.split('\n').map(line => line.split(','));
                const header = lines[0].slice(0, 4); 
                const rows = lines.slice(1);

                const headerHtml = header.map(col => `<th>${col}</th>`).join('');
                $('#dataTable thead').html(`<tr>${headerHtml}</tr>`);

                allRows = rows.map((row, index) => {
                    const limitedRow = row.slice(0, 4); 

                    if (limitedRow.length >= 4) {
                        const secondColumnText = limitedRow[1]; 
                        const link = limitedRow[3]; 

                        if (link && link.trim().startsWith('https://')) {
                            limitedRow[1] = `<a href="${link}" target="_blank">${secondColumnText}</a>`;
                        } else {
                            limitedRow[3] = '';
                        }
                    }

                    return `<tr data-id="${index}">${limitedRow.map(cell => `<td>${cell}</td>`).join('')}</tr>`;
                });

                originalRows = allRows.slice(); 
                $('#dataTable tbody').html(originalRows.join(''));

                // Row click to toggle selection
                $('#dataTable tbody').on('click', 'tr', function() {
                    const rowIndex = $(this).index();
                    $(this).toggleClass('selected-row');
                    $(this).removeClass('new-row'); 
                    if (selectedRows.has(rowIndex)) {
                        selectedRows.delete(rowIndex);
                    } else {
                        selectedRows.add(rowIndex);
                    }
                });

                // Display only selected rows when "Display Selected" is clicked
                $('#displaySelected').click(function() {
                    const selectedHtml = $('#dataTable tbody tr.selected-row').clone();
                    const unselectedHtml = $('#dataTable tbody tr').not('.selected-row').clone();

                    if (selectedHtml.length === 0) {
                        $('#dataTable tbody').html(originalRows.join(''));
                        selectedRows.clear();
                    } else {
                        $('#dataTable tbody').empty().append(selectedHtml).append(unselectedHtml);
                    }
                });

                // Reset button functionality
                $('#reset').click(function() {
                    $('#dataTable tbody tr').removeClass('selected-row new-row');
                    selectedRows.clear();
                    $('#dataTable tbody').html(originalRows.join(''));
                    displayedRows.clear(); 
                    newTopRows.clear(); 
                });

                // Clear Context button functionality (updates made here)
                $('#clearContext').click(function() {
                    $('#keywordInput').val(''); // Clear the keyword input

                    // Keep selected rows intact, reset the rest to original state
                    $('#dataTable tbody tr').each(function() {
                        if (!$(this).hasClass('selected-row')) {
                            $(this).removeClass('new-row'); // Revert green rows
                        }
                    });
                });

                // Export functionality
                $('#export').click(function() {
                    let csvContent = header.join(',') + '\n';
                    $('#dataTable tbody tr.selected-row').each(function() {
                        const row = $(this).find('td').map(function() {
                            return $(this).text().trim();
                        }).get();
                        if (row.some(cell => cell.length > 0)) {
                            csvContent += row.join(',') + '\n';
                        }
                    });

                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.setAttribute('href', URL.createObjectURL(blob));
                    link.setAttribute('download', 'selected_rows.csv');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });

                function extractKeywords(context) {
                    return context.match(/(?:\w+\s+){0,2}\w+/g) || [];
                }

                function extractNumbers(context) {
                    return context.match(/\d+/g) || []; 
                }

                function matchAndDisplay(matchingItems) {
                    // Reset the green highlighting for previously green rows unless they are selected
                    $('#dataTable tbody tr').each(function() {
                        if (!$(this).hasClass('selected-row')) {
                            $(this).removeClass('new-row'); 
                        }
                    });

                    matchingItems.forEach(item => {
                        allRows.forEach((rowHtml, index) => {
                            const rowText = $(rowHtml).text().toLowerCase(); 
                            if (rowText.includes(item.trim().toLowerCase())) {
                                const rowId = $(rowHtml).data('id');
                                if (!displayedRows.has(rowId)) {
                                    $('#dataTable tbody').prepend(rowHtml); 
                                    displayedRows.add(rowId); 
                                    newTopRows.add(rowId); 
                                }
                            }
                        });
                    });

                    $('#dataTable tbody tr').each(function() {
                        const rowId = $(this).data('id');
                        if (newTopRows.has(rowId) && !$(this).hasClass('selected-row')) {
                            $(this).addClass('new-row'); 
                        } else if (!selectedRows.has(rowId)) {
                            $(this).removeClass('new-row'); 
                        }
                    });
                }

                $('#submitContext').click(function() {
                    const context = $('#keywordInput').val();
                    $('#loadingIndicator').show(); 
                    $('#progressMessage').text('Searching...'); 

                    const numbers = extractNumbers(context);
                    const keywords = extractKeywords(context);

                    newTopRows.clear(); // Clear previous new rows set

                    matchAndDisplay(numbers); 
                    matchAndDisplay(keywords); 

                    $('#loadingIndicator').hide(); 
                    $('#progressMessage').text('Search complete.'); 
                });
            });

            $('<style>').prop('type', 'text/css').html(`
                .new-row {
                    background-color: lightgreen;
                }
            `).appendTo('head');
        });
    </script>
</body>
</html>
